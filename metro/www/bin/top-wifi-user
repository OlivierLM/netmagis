#!/usr/bin/perl

# $Id: top-wifi-user,v 1.2 2008/06/13 10:01:06 pda Exp $
#
#
# ###################################################################
# boggia : Creation : 31/03/08
#
# page permettant d'afficher la liste des utilisateurs qui ont 
# utilisé le réseau sans fil entre 2 dates.
#
#


use CGI qw/:standard/;
use CGI::Pretty qw( :html3 );
use DBI;

# fichier de configuration principal et chargement des focntions de base
our $conf_file = "%CONF%";
require "%LIBMETRO%";
#
$server_hostname = read_conf_file($conf_file,"WWW_IDRIS_HOSTNAME");
$www_root = read_conf_file($conf_file,"WWW_IDRIS_DIR_ROOT");
$www_bin = read_conf_file($conf_file,"WWW_IDRIS_DIR_BIN");
$www_img = read_conf_file($conf_file,"WWW_IDRIS_DIR_IMG");
$www_graph = read_conf_file($conf_file,"WWW_IDRIS_DIR_GRAPHS");
# repertoire des binaires
$rep_bin = read_conf_file($conf_file,"DIR_BIN");
#repertoire dans lequel se trouve la liste des graphiques existants avec le modele a utiliser
$rep_etc = read_conf_file($conf_file,"DIR_ETC");

# arguments de connexion a la base PSQL
$dbhost = read_conf_file($conf_file,"MAC_PSQL_SERVER");
$dbname = read_conf_file($conf_file,"PG_DATABASE_MAC");
$dbuser = read_conf_file($conf_file,"PG_USER_MAC");
$dbpass = read_conf_file($conf_file,"PG_PASSWORD_MAC");

@liste_annees = qw(2004 2005 2006 2007 2008 2009 2010);
@liste_mois = qw(01 02 03 04 05 06 07 08 09 10 11 12);
@liste_jours = qw(01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31);
@heures = qw(00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23);

$interval="300";

$log = $ARGV[0];

$defaultdomain="u-strasbg.fr";

# Récupération de l'heure d'aujourd'hui
$time_fin = time + 3600;
$time_debut = $time_fin - 2592000;
($sec_dep,$min_dep,$heure_dep,$jour_dep,$mois_dep,$annee_dep)=localtime($time_debut);
($sec_fin,$min_fin,$heure_fin,$jour_fin,$mois_fin,$annee_fin)=localtime($time_fin);
$mois_dep ++;
$mois_fin ++;
$annee_dep = $annee_dep + 1900;
$annee_fin = $annee_fin + 1900;

print header();

if (param(-name=>'go!'))
{
	$conf = (param('conf'));
	$liste_graph = (param('liste_graph'));
	$heure_dep = (param('heure_dep'));
        $jour_dep = (param('jour_dep'));
        $mois_dep = (param('mois_dep'));
	$annee_dep = (param('annee_dep'));
	$heure_fin = (param('heure_fin'));
        $jour_fin = (param('jour_fin'));
        $mois_fin = (param('mois_fin'));
        $annee_fin = (param('annee_fin'));

	ecrit_formulaire($nom_user,$heure_dep,$jour_dep,$mois_dep,$annee_dep,$heure_fin,$jour_fin,$mois_fin,$annee_fin,$conf);
}
else
{
	$conf = (param('conf'));
	ecrit_formulaire($nom_user,$heure_dep,$jour_dep,$mois_dep,$annee_dep,$heure_fin,$jour_fin,$mois_fin,$annee_fin,$conf);
	
}


sub ecrit_formulaire {
        ($nom_user,$heure_dep,$jour_dep,$mois_dep,$annee_dep,$heure_fin,$jour_fin,$mois_fin,$annee_fin,$conf)=@_;
	
	print "<HTML><HEAD><TITLE>TOP WiFi Users</TITLE>
        <META HTTP-EQUIV=\"Cache-Control\" content=\"no-cache\">
        <META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">
        </HEAD>
        <BODY>
        <form>
	<h2 align = center>
        Liste des utilisateurs
	</h2>";
	if($conf eq "avec")
	{
		print "
        	<input type=radio name=conf value=sans>Sans les conférences<br/>
        	<input type=radio name=conf value=avec checked>Avec les conférences";
	}
	else
	{
		print "
		<input type=radio name=conf value=sans checked>Sans les conférences<br/>
		<input type=radio name=conf value=avec>Avec les conférences";
	}
	print "
        <br/>
        de :<br>
        <select name=heure_dep>";
                foreach $e (@heures)
                {
                        if($heure_dep == $e)
                        {
                                print "<option selected>$e";
                                $heure_dep = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>heures, le&nbsp;
        <select name=jour_dep>";
                foreach $e (@liste_jours)
                {
                        if($jour_dep == $e)
                        {
                                print "<option selected>$e";
                                $jour_dep = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <select name=mois_dep>";
                foreach $e (@liste_mois)
                {
                        if($mois_dep == $e)
                        {
                                print "<option selected>$e";
                                $mois_dep ="$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
	<select name=annee_dep>";
                foreach $e (@liste_annees)
                {
                        if($annee_dep == $e)
                        {
                                print "<option selected>$e";
                                $annee_dep = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <br>
        à :<br>
        <select name=heure_fin>";
                foreach $e (@heures)
                {
                        if($heure_fin == $e)
                        {
                                print "<option selected>$e";
                                $heure_fin = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>heures, le&nbsp;
        <select name=jour_fin>";
                foreach $e (@liste_jours)
                {
                        if($jour_fin == $e)
                        {
                                print "<option selected>$e";
                                $jour_fin = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
	<select name=mois_fin>";
                foreach $e (@liste_mois)
                {
                        if($mois_fin == $e)
                        {
                                print "<option selected>$e";
                                $mois_fin = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <select name=annee_fin>";
                foreach $e (@liste_annees)
                {
                        if($annee_fin == $e)
                        {
                                print "<option selected>$e";
                                $annee_fin = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <br><br>
        <input type=submit name=\"go!\" value=\"go!\">
        </form>";

        $db =  DBI->connect("dbi:Pg:dbname=$dbname;host=$dbhost", $dbuser, $dbpass )
        or print STDERR "$DBI::errstr";

        $debut = "$annee_dep-$mois_dep-$jour_dep $heure_dep:00:00";
        $fin = "$annee_fin-$mois_fin-$jour_fin $heure_fin:00:00";
	if($conf eq "sans")
	{
		$sql = "SELECT count (DISTINCT LOWER(authaccess.login)) FROM authaccess,sessionauthaccess
        	WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
		AND LOWER(authaccess.login) not like 'conf-%'
		AND authaccess.ideq!=(select ideq from eq where nom='vpn.u-strasbg.fr') 
        	AND sessionauthaccess.fin < '$fin'
        	AND sessionauthaccess.debut > '$debut';
		";
		$cursor = $db->prepare($sql);
        	$cursor->execute;	
		$nb_users = $cursor->fetchrow;
	
		$sql = "
		SELECT count (sessionauthaccess.idauthaccess) FROM authaccess,sessionauthaccess
        	WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
		AND LOWER(authaccess.login) not like 'conf-%'
        	AND sessionauthaccess.fin < '$fin'
        	AND sessionauthaccess.debut > '$debut';
        	";
        	$cursor = $db->prepare($sql);
        	$cursor->execute;
        	$nb_sessions = $cursor->fetchrow;

		$sql = "
		SELECT count (sessionauthaccess.idauthaccess) FROM authaccess,sessionauthaccess
        	WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
		AND LOWER(authaccess.login) not like 'conf-%'
        	AND authaccess.ideq=(select ideq from eq where nom='ash.u-strasbg.fr')
        	AND sessionauthaccess.fin < '$fin'
        	AND sessionauthaccess.debut > '$debut';
        	";
        	$cursor = $db->prepare($sql);
        	$cursor->execute;
        	$nb_sessions_ash = $cursor->fetchrow;

		$nb_sessions_8021X = $nb_sessions - $nb_sessions_ash;

		$sql = "SELECT JUSTIFY_HOURS(SUM(sessionauthaccess.fin - sessionauthaccess.debut))
		AS duree
                FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut'
                AND LOWER(authaccess.login) not like 'conf-%';
                ";

                $cursor = $db->prepare($sql);
                $cursor->execute;

		$cumul_temps = $cursor->fetchrow;
		($cumul_temps) = (split(/\./,$cumul_temps))[0];

		$sql = "SELECT JUSTIFY_HOURS(SUM(sessionauthaccess.fin - sessionauthaccess.debut)) 
		AS duree
                FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
		AND authaccess.ideq=(select ideq from eq where nom='ash.u-strasbg.fr')
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut'
                AND LOWER(authaccess.login) not like 'conf-%';
                ";

                $cursor = $db->prepare($sql);
                $cursor->execute;

                $cumul_temps_ash = $cursor->fetchrow;
                ($cumul_temps_ash) = (split(/\./,$cumul_temps_ash))[0];

		$sql = "SELECT JUSTIFY_HOURS(SUM(sessionauthaccess.fin - sessionauthaccess.debut)) 
		AS duree
                FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
                AND authaccess.ideq=(select ideq from eq where nom='nephtys.u-strasbg.fr')
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut'
                AND LOWER(authaccess.login) not like 'conf-%';
                ";

                $cursor = $db->prepare($sql);
                $cursor->execute;

                $cumul_temps_nephtys = $cursor->fetchrow;
                ($cumul_temps_nephtys) = (split(/\./,$cumul_temps_nephtys))[0];


        	$sql = "SELECT LOWER(authaccess.login), 
		JUSTIFY_HOURS(SUM(sessionauthaccess.fin - sessionauthaccess.debut)) AS duree
        	FROM authaccess,sessionauthaccess
        	WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
        	AND sessionauthaccess.fin < '$fin'
        	AND sessionauthaccess.debut > '$debut'
        	AND authaccess.login not like 'conf-%'
        	GROUP BY LOWER(authaccess.login)
        	ORDER BY duree DESC;
        	";

        	$cursor = $db->prepare($sql);
        	$cursor->execute;

	}
	else
	{
		$sql = "SELECT count (DISTINCT LOWER(authaccess.login)) FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut';
                ";
                $cursor = $db->prepare($sql);
                $cursor->execute;
                $nb_users = $cursor->fetchrow;

                $sql = "
                SELECT count (sessionauthaccess.idauthaccess) FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut';
                ";
                $cursor = $db->prepare($sql);
                $cursor->execute;
                $nb_sessions = $cursor->fetchrow;

                $sql = "
                SELECT count (sessionauthaccess.idauthaccess) FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
                AND authaccess.ideq=(select ideq from eq where nom='ash.u-strasbg.fr')
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut';
                ";
                $cursor = $db->prepare($sql);
                $cursor->execute;
                $nb_sessions_ash = $cursor->fetchrow;

                $nb_sessions_8021X = $nb_sessions - $nb_sessions_ash;

		$sql = "SELECT JUSTIFY_HOURS(SUM(sessionauthaccess.fin - sessionauthaccess.debut)) 
		AS duree
                FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut';
                ";

                $cursor = $db->prepare($sql);
                $cursor->execute;

                $cumul_temps = $cursor->fetchrow;
		($cumul_temps) = (split(/\./,$cumul_temps))[0];
	
		$sql = "SELECT JUSTIFY_HOURS(SUM(sessionauthaccess.fin - sessionauthaccess.debut)) 
		AS duree
                FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
                AND authaccess.ideq=(select ideq from eq where nom='ash.u-strasbg.fr')
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut';
                ";

                $cursor = $db->prepare($sql);
                $cursor->execute;

                $cumul_temps_ash = $cursor->fetchrow;
                ($cumul_temps_ash) = (split(/\./,$cumul_temps_ash))[0];
	
		$sql = "SELECT JUSTIFY_HOURS(SUM(sessionauthaccess.fin - sessionauthaccess.debut)) 
		AS duree
                FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
                AND authaccess.ideq=(select ideq from eq where nom='nephtys.u-strasbg.fr')
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut';
                ";

                $cursor = $db->prepare($sql);
                $cursor->execute;

                $cumul_temps_nephtys = $cursor->fetchrow;
                ($cumul_temps_nephtys) = (split(/\./,$cumul_temps_nephtys))[0];

                $sql = "SELECT LOWER(authaccess.login), 
		JUSTIFY_HOURS(SUM(sessionauthaccess.fin - sessionauthaccess.debut)) AS duree
                FROM authaccess,sessionauthaccess
                WHERE authaccess.idauthaccess = sessionauthaccess.idauthaccess
                AND sessionauthaccess.fin < '$fin'
                AND sessionauthaccess.debut > '$debut'
                GROUP BY LOWER(authaccess.login)
                ORDER BY duree DESC;
                ";

                $cursor = $db->prepare($sql);
                $cursor->execute;
	}

        @tab = ();
	@tempo = ();
        $i = 0;
	print "<table align=center>
		<tr>
		<td valign=top>
		
		<table align=center >
		<tr>
			<td align = left>
			Nombre d'utilisateurs : 
			</td>
			<td align = right>
                        <b>$nb_users</b>
                        </td>
			<td align = right>
			&nbsp;&nbsp;&nbsp;&nbsp;
                        </td>
		</tr>
		<tr>	
			<td align = left>
                        &nbsp;
                        </td>
			<td align = left>
                        &nbsp;
                        </td>
			<td align = left>
                        &nbsp;
                        </td>
		</tr>
		<tr>
			<td align = left>
			Nombre de sessions globales :
			</td>
			<td align = right>
				<b>$nb_sessions</b>
			</td> 
			<td align = center>
                        </td>
		 </tr>
		<tr>
			<td align = left>
                                Nombre de sessions 802.1X :
                        </td>
			<td align = right>
                        <b>$nb_sessions_8021X</b>
			</td>
                        <td align = right>
                        </td>
		</tr>
		<tr>
                        <td align = left>
                                Nombre de sessions sur le portail captif :
			</td>
                        <td align = right>
                        <b>$nb_sessions_ash</b>
                        </td>
                        <td align = right>
                        </td>
                </tr>
		<tr>
                        <td align = left>
                        &nbsp;
                        </td>
                        <td align = left>
                        &nbsp;
                        </td>
                        <td align = left>
                        &nbsp;
                        </td>
                </tr>
                <tr>
                        <td align = left>
                        	Temps d'utilisation global cumulé :
                        </td>
                        <td align = center>
                                <b>$cumul_temps</b>
                        </td>
                        <td align = center>
                        </td>
                 </tr>
		<tr>
                        <td align = left>
                                Temps d'utilisation en 802.1X cumulé :
                        </td>
                        <td align = right>
                        <b>$cumul_temps_nephtys</b>
                        </td>
                        <td align = right>
                        </td>
                </tr>
		<tr>
                        <td align = left>
                                Temps d'utilisation du portail captif cumulé :
                        </td>
                        <td align = right>
                        <b>$cumul_temps_ash</b>
                        </td>
                        <td align = right>
                        </td>
                </tr>


		</table>

		</td>
		<td>";
	print "<table align=center CELLPADDING=0 CELLSPACING=0 BORDER=1>
                        <tr BGCOLOR=#CCCCCCC><td align=center>rang</td><td align=center>User</td><td align=center>cumul des connexions</td>
                        </tr>";
        while( ($tab[$i][0],$tab[$i][1]) = $cursor->fetchrow )
        {
                ($tab[$i][1]) = (split(/\./,$tab[$i][1]))[0];
		$rang = $i + 1;
		print "<tr><td align=right>$rang</td><td align=center>
			<a href=\"https://$server_hostname/$www_bin/cherche-wifiuser?nom_user=$tab[$i][0]
			&heure_dep=$heure_dep&jour_dep=$jour_dep&mois_dep=$mois_dep&annee_dep=$annee_dep
			&heure_fin=$heure_fin&jour_fin=$jour_fin&mois_fin=$mois_fin&annee_fin=$annee_fin
			&go%21=go%21\">$tab[$i][0]</a>
			</td><td align=center>$tab[$i][1]</td></tr>";
		$i++;
        }

        print "</table></td></tr></table>";

        $cursor->finish;
        $db->disconnect;
        print "
        <br>
        </BODY></HTML> ";

}

