#!/usr/bin/perl

# $Id: cherche-wifiap,v 1.2 2008-06-13 10:01:06 pda Exp $
#
#
# ###################################################################
# boggia : Creation : 31/03/08
#
# page permettant d'afficher les connexions pour un AP ou un site
#
#

use CGI qw/:standard/;
use CGI::Pretty qw( :html3 );
use DBI;
use Time::Local;

# fichier de configuration principal et chargement des focntions de base
our $conf_file = "%CONF%";
require "%LIBMETRO%";
#
$server_hostname = read_conf_file($conf_file,"WWW_IDRIS_HOSTNAME");
$www_root = read_conf_file($conf_file,"WWW_IDRIS_DIR_ROOT");
$www_bin = read_conf_file($conf_file,"WWW_IDRIS_DIR_BIN");
$www_img = read_conf_file($conf_file,"WWW_IDRIS_DIR_IMG");
$www_graph = read_conf_file($conf_file,"WWW_IDRIS_DIR_GRAPHS");
# repertoire des binaires
$rep_bin = read_conf_file($conf_file,"DIR_BIN");
#repertoire dans lequel se trouve la liste des graphiques existants avec le modele a utiliser
$rep_etc = read_conf_file($conf_file,"DIR_ETC");

# arguments de connexion a la base PSQL
$dbhost = read_conf_file($conf_file,"MAC_PSQL_SERVER");
$dbname = read_conf_file($conf_file,"PG_DATABASE_MAC");
$dbuser = read_conf_file($conf_file,"PG_USER_MAC");
$dbpass = read_conf_file($conf_file,"PG_PASSWORD_MAC");

@liste_annees = qw(2004 2005 2006 2007 2008);
@liste_mois = qw(01 02 03 04 05 06 07 08 09 10 11 12);
@liste_jours = qw(01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31);
@heures = qw(00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23);

$interval="300";

$log = $ARGV[0];

$defaultdomain="u-strasbg.fr";

# Récupération de l'heure d'aujourd'hui
$time_fin = time + 3600;
$time_debut = $time_fin - 2592000;
($sec_dep,$min_dep,$heure_dep,$jour_dep,$mois_dep,$annee_dep)=localtime($time_debut);
($sec_fin,$min_fin,$heure_fin,$jour_fin,$mois_fin,$annee_fin)=localtime($time_fin);
$mois_dep ++;
$mois_fin ++;
$annee_dep = $annee_dep + 1900;
$annee_fin = $annee_fin + 1900;

print header();

if (param(-name=>'go!'))
{
	$nom_ap = (param('nom_ap'));
	$liste_graph = (param('liste_graph'));
	$heure_dep = (param('heure_dep'));
        $jour_dep = (param('jour_dep'));
        $mois_dep = (param('mois_dep'));
	$annee_dep = (param('annee_dep'));
	$heure_fin = (param('heure_fin'));
        $jour_fin = (param('jour_fin'));
        $mois_fin = (param('mois_fin'));
        $annee_fin = (param('annee_fin'));


	ecrit_formulaire($nom_ap,$heure_dep,$jour_dep,$mois_dep,$annee_dep,$heure_fin,$jour_fin,$mois_fin,$annee_fin);
}
else
{
	$nom_ap = (param('nom_ap'));

        ecrit_formulaire($nom_ap,$heure_dep,$jour_dep,$mois_dep,$annee_dep,$heure_fin,$jour_fin,$mois_fin,$annee_fin);

}


sub ecrit_formulaire {
        ($nom_ap,$heure_dep,$jour_dep,$mois_dep,$annee_dep,$heure_fin,$jour_fin,$mois_fin,$annee_fin)=@_;
	
	print "<HTML><HEAD><TITLE>cherche bâtiment</TITLE>
        <META HTTP-EQUIV=\"Cache-Control\" content=\"no-cache\">
        <META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">
        </HEAD>
        <BODY>
        <form>
	<TABLE>
		<TR>
		<TD>
        chercher le bâtiment : <INPUT TYPE=\"TEXT\" NAME=\"nom_ap\" SIZE=\"20\" VALUE=$nom_ap>
		</TD>
		<TD>
	<blockquote>ex : <b><i>dpt-info</i></b> pour l'UFR de math, <b><i>dpt-info-ap1</i></b> pour l'AP1.
		</TD>
		</TR>
	<TABLE>
        <br>
        de :<br>
        <select name=heure_dep>";
                foreach $e (@heures)
                {
                        if($heure_dep == $e)
                        {
                                print "<option selected>$e";
                                $heure_dep = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>heures, le&nbsp;
        <select name=jour_dep>";
                foreach $e (@liste_jours)
                {
                        if($jour_dep == $e)
                        {
                                print "<option selected>$e";
                                $jour_dep = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <select name=mois_dep>";
                foreach $e (@liste_mois)
                {
                        if($mois_dep == $e)
                        {
                                print "<option selected>$e";
                                $mois_dep ="$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
	<select name=annee_dep>";
                foreach $e (@liste_annees)
                {
                        if($annee_dep == $e)
                        {
                                print "<option selected>$e";
                                $annee_dep = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <br>
        à :<br>
        <select name=heure_fin>";
                foreach $e (@heures)
                {
                        if($heure_fin == $e)
                        {
                                print "<option selected>$e";
                                $heure_fin = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>heures, le&nbsp;
        <select name=jour_fin>";
                foreach $e (@liste_jours)
                {
                        if($jour_fin == $e)
                        {
                                print "<option selected>$e";
                                $jour_fin = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
	<select name=mois_fin>";
                foreach $e (@liste_mois)
                {
                        if($mois_fin == $e)
                        {
                                print "<option selected>$e";
                                $mois_fin = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <select name=annee_fin>";
                foreach $e (@liste_annees)
                {
                        if($annee_fin == $e)
                        {
                                print "<option selected>$e";
                                $annee_fin = "$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <br><br>
        <input type=submit name=\"go!\" value=\"go!\">
        </form>";

        $db =  DBI->connect("dbi:Pg:dbname=$dbname;host=$dbhost", $dbuser, $dbpass )
        or print STDERR "$DBI::errstr";

        $debut = "$annee_dep-$mois_dep-$jour_dep $heure_dep:00:00";
        $fin = "$annee_fin-$mois_fin-$jour_fin $heure_fin:00:00";
        #$sec_dep,$min_dep,$heure_dep,$jour_dep,$mois_dep,$annee_dep

        $sql = "SELECT  LOWER(authaccess.login),authaccess.mac, assocwifi.essid AS ssid,
            sessionauthaccess.debut AS authdebut,
            sessionauthaccess.fin AS authfin,
            eq2.nom AS assoc_eq,
            sessionassocwifi.debut AS assocdebut,
            sessionassocwifi.fin AS assocfin
       	FROM authaccess, eq eq1, eq eq2, sessionauthaccess, assocwifi, sessionassocwifi
        WHERE
        sessionauthaccess.idauthaccess = authaccess.idauthaccess
        AND eq1.ideq = authaccess.ideq
        AND eq2.ideq = assocwifi.ideq
	AND eq2.nom like '$nom_ap%'
        AND assocwifi.idassocwifi =  sessionassocwifi.idassocwifi
        AND assocwifi.mac = authaccess.mac
        AND (
                abs(extract(epoch from age(sessionauthaccess.debut,sessionassocwifi.debut)))
                 < $interval
                    OR
                (sessionauthaccess.debut, sessionauthaccess.fin)
                    overlaps (sessionassocwifi.debut, sessionassocwifi.fin)
                    OR
                abs(extract(epoch from age(sessionauthaccess.fin,sessionassocwifi.fin)))
                 < $interval
            )
        AND sessionauthaccess.fin > '$debut'
        AND sessionauthaccess.debut < '$fin'
	order by sessionauthaccess.debut, sessionassocwifi.debut
        ";

        $cursor = $db->prepare($sql);
        $cursor->execute;

        @tab = ();
	@tempo = ();
        $i = 0;

	%nb_assoc = ();
	$nb_assoc_tot = 0;
	%temps_cumul = ();
	%liste_mac = ();
	%liste_users = ();

        while( ($tab[$i][0],$tab[$i][1],$tab[$i][2],$tab[$i][3],$tab[$i][4],$tab[$i][5],$tab[$i][6],$tab[$i][7]) = $cursor->fetchrow )
        {
		($tab[$i][5]) = (split(/\./,$tab[$i][5]))[0];
		($tab[$i][2]) = (split(/\./,$tab[$i][2]))[0];
                ($tab[$i][3]) = (split(/\./,$tab[$i][3]))[0];
                ($tab[$i][4]) = (split(/\./,$tab[$i][4]))[0];
                ($tab[$i][6]) = (split(/\./,$tab[$i][6]))[0];
                ($tab[$i][7]) = (split(/\./,$tab[$i][7]))[0];
		if($liste_users{'global'} !~ m/;$tab[$i][0];/)
                {
			$liste_users{'global'} = "$liste_users{'global'}" . ";$tab[$i][0];";
                }
		if($liste_users{$tab[$i][5]} !~ m/;$tab[$i][0];/)
		{
			$liste_users{$tab[$i][5]} = "$liste_users{$tab[$i][5]}" . ";$tab[$i][0];";
		}
		if($liste_mac{'global'} !~ m/;$tab[$i][1];/)
                {
                        $liste_mac{'global'} = "$liste_mac{'global'}" . ";$tab[$i][1];";
                }
		if($liste_mac{$tab[$i][5]} !~ m/;$tab[$i][1];/)
		{
                        $liste_mac{$tab[$i][5]} = "$liste_mac{$tab[$i][5]}" . ";$tab[$i][1];";
		}
		
		if($i > 0)
		{
			if($tab[$i][6] ne $temp[1] || $tab[$i][7] ne $temp[2] || $tab[$i][1] ne $temp[0])
			{
				$nb_assoc{$tab[$i][5]} = $nb_assoc{$tab[$i][5]} + 1;
				$nb_assoc_tot = $nb_assoc_tot + 1;
			}
        	}
		elsif($i == 0)
		{
			$nb_assoc{$tab[$i][5]} = $nb_assoc{$tab[$i][5]} + 1;
			$nb_assoc_tot = $nb_assoc_tot + 1;
		}
		$temp[0]=$tab[$i][1];
		$temp[1]=$tab[$i][6];
		$temp[2]=$tab[$i][7]; 
       
		($temps_date,$temps_heure) = (split(/\s+/,$tab[$i][3]))[0,1];
		($a_debut,$m_debut,$j_debut) = (split(/-/,$temps_date))[0,1,2];
		$a_debut = $a_debut - 1900;
		$m_debut = $m_debut - 1;
		($h_debut,$mi_debut,$s_debut) = (split(/:/,$temps_heure))[0,1,2];
		
		($temps_date,$temps_heure) = (split(/\s+/,$tab[$i][4]))[0,1];
                ($a_fin,$m_fin,$j_fin) = (split(/-/,$temps_date))[0,1,2];
                $a_fin = $a_fin - 1900;
                $m_fin = $m_fin - 1;
                ($h_fin,$mi_fin,$s_fin) = (split(/:/,$temps_heure))[0,1,2];

		$timegm_fin = timegm($s_fin,$mi_fin,$h_fin,$j_fin,$m_fin,$a_fin);
		$timegm_deb = timegm($s_debut,$mi_debut,$h_debut,$j_debut,$m_debut,$a_debut);

		#print "$timegm_fin = timegm($s_fin,$mi_fin,$h_fin,$j_fin,$m_fin,$a_fin) $timegm_deb = timegm($s_debut,$mi_debut,$h_debut,$j_debut,$m_debut,$a_debut)<br>";	
		$temps_assoc_secondes = $timegm_fin - $timegm_deb;
		$temps_cumul{$tab[$i][5]} = $temps_cumul{$tab[$i][5]} + $temps_assoc_secondes;
		$temps_cumul{'global'} = $temps_cumul{'global'} + $temps_assoc_secondes;
		#$a = $a - 1900;
		#$m = $m - 1;
		#$gmtdate = timegm($s,$mi,$h,$j,$m,$a);
		
		for($j=0;$j<8;$j++)
		{
			if($j == 0)
			{
				$tab[$i][$j] = "<a href=\"https://$server_hostname$www_bin/cherche-wifiuser?nom_user=$tab[$i][$j]&heure_dep=$heure_dep&jour_dep=$jour_dep&mois_dep=$mois_dep&annee_dep=$annee_dep&heure_fin=$heure_fin&jour_fin=$jour_fin&mois_fin=$mois_fin&annee_fin=$annee_fin&go%21=go%21\">$tab[$i][$j]</a>";

			}
			if($j == 1)
                        {
                                $tab[$i][$j] = "<a href=\"https://$server_hostname$www_bin/cherche-wifimac?mac=$tab[$i][$j]&heure_dep=$heure_dep&jour_dep=$jour_dep&mois_dep=$mois_dep&annee_dep=$annee_dep&heure_fin=$heure_fin&jour_fin=$jour_fin&mois_fin=$mois_fin&annee_fin=$annee_fin&go%21=go%21\">$tab[$i][$j]</a>";
                        }
			$tampon_donnee = $tab[$i][$j];
			if($tempo[$j] eq $tab[$i][$j])
			{
				$tab[$i][$j] = "|";
			}
			$tempo[$j] = $tampon_donnee;
		}
		
                $i++;
        }

	print "<table align=center CELLPADDING=0 CELLSPACING=0 BORDER=1>
               	<tr BGCOLOR=#CCCCCCC>
	       	<td align=center>AP (localiser)</td>
	       	<td align=center>Associations</td>
	       	<td align=center>Utilisateurs</td>
	       	<td align=center>Ordinateurs</td>
	       	<td align=center>Temps cumulé</td>";
	       	foreach $ap (sort keys %nb_assoc)
		{
			@batiment = split(/-/,$ap);
			$t_bat = @batiment;
			$bat = "$batiment[0]";
			for($i=1;$i<$t_bat-1;$i++)
			{
				$bat = "$bat-$batiment[$i]";
			}
			print "	<tr><td align=center><a href=\"https://$server_hostname$www_img/ap-stats?nom_ap=$ap\">$ap</a></td>	
				<td align=center>$nb_assoc{$ap}</td>";
				@liste_mac = split(/;;/,$liste_mac{$ap});
				@liste_users = split(/;;/,$liste_users{$ap});
				$nb_mac = @liste_mac;
				$nb_users = @liste_users;
				
				$reste = $temps_cumul{$ap} % 86400;
				$nombre_jours = ( $temps_cumul{$ap} - $reste ) / 86400;
				$reste2 = $reste % 3600;
				$nombre_heures = ($reste - $reste2) / 3600;
				$reste3 = $reste2 % 60;
				$nombre_minutes = ( $reste2 - $reste3 ) / 60;
				$nombre_secondes = $reste3; 
			print "	<td align=center>$nb_users</td>
				<td align=center>$nb_mac</td>
				<td align=center>$nombre_jours <i>jours</i>  $nombre_heures:$nombre_minutes:$nombre_secondes</td></tr>";
	#		print " <td align=center>$nb_users</td>
         #                      <td align=center>$nb_mac</td>
	#		<td align=center> $temps_cumul{$ap}";

		}
		print "<tr><td align=center><b>Global</b></td>
			<td align=center><b>$nb_assoc_tot</b></td>";
			@liste_mac = split(/;;/,$liste_mac{'global'});
			@liste_users = split(/;;/,$liste_users{'global'});
			$nb_mac = @liste_mac;
                        $nb_users = @liste_users;
			
			$reste = $temps_cumul{'global'} % 86400;
                        $nombre_jours = ( $temps_cumul{'global'} - $reste ) / 86400;
                        $reste2 = $reste % 3600;
                        $nombre_heures = ($reste - $reste2) / 3600;
                        $reste3 = $reste2 % 60;
                        $nombre_minutes = ( $reste2 - $reste3 ) / 60;
                        $nombre_secondes = $reste3;

                        print " <td align=center><b>$nb_users</b></td>
                                <td align=center><b>$nb_mac</b></td>
			<td align=center><b>$nombre_jours <i>jours</i>  $nombre_heures:$nombre_minutes:$nombre_secondes</b></td></tr>";
		
		print "</table><br/><br/>";		

	print "	<table align=center CELLPADDING=0 CELLSPACING=0 BORDER=1>
               	<tr BGCOLOR=#CCCCCCC>
               	<td align=center>user</td>
               	<td align=center>mac</td><td align=center>SSID</td>
               	<td align=center>debut auth</td>
               	<td align=center>fin auth</td><td align=center>ap</td>
               	<td align=center>debut assoc</td>
               	<td align=center>fin assoc</td><TD>&nbsp;</TD>";

	$t_table = @tab;
	for($i=0;$i<$t_table-1;$i++)
	{
		print "<tr>";
		for($j=0;$j<8;$j++)
                {
			$rowspan = 1;
			if($tab[$i][$j] ne "|" && $j < 8)
			{
				$k = 1;
				while($tab[$i+$k][$j] eq "|" && $j < 8)
				{
					$rowspan ++;
					$k++;	
				}
			}
			if($rowspan > 1 )
			{
				print"<td align=center rowspan=$rowspan>&nbsp;$tab[$i][$j]&nbsp;</td>";
			}
			else
			{
				if($tab[$i][$j] eq "|" && $j < 8)
				{
				}
				else
				{
                                        print"<td align=center>&nbsp;$tab[$i][$j]&nbsp;</td>";
				}
			}
		}	
                print "<TD><img src=https://$server_hostname$www_img/tournesol20.jpg></img></TD></tr>";
	}

        print "</table>";

        $cursor->finish;
        $db->disconnect;
        print "
        <br>
        </BODY></HTML> ";

}

