#!/usr/bin/perl

# $Id: ap-stats,v 1.2 2008-06-13 10:01:06 pda Exp $
#
#
# ###################################################################
# boggia : Creation : 31/03/08
#
# page de génération des pages de graphiques rrdtools
#
#

use CGI qw/:standard/;
use CGI::Pretty qw( :html3 );
use DBI;

# fichier de configuration principal et chargement des focntions de base
our $conf_file = "%CONF%";
require "%LIBMETRO%";
#

$server_hostname = read_conf_file($conf_file,"WWW_IDRIS_HOSTNAME");
#repertoire dans lequel sont stockes les scripts de generation de graphs
$rep_modeles = read_conf_file($conf_file,"DIR_BIN_MODELS");
#repertoire dans lequel se trouve la liste des graphiques existants avec le modele a utiliser
$rep_etc = read_conf_file($conf_file,"DIR_ETC");
#repertoire des bases de données
$rep_db = read_conf_file($conf_file,"DIR_RRD_DB");
# repertoire des binaires
$rep_bin = read_conf_file($conf_file,"DIR_BIN");

$dbhost = read_conf_file($conf_file,"MAC_PSQL_SERVER");
$dbname= read_conf_file($conf_file,"PG_DATABASE_MAC");
$dbuser= read_conf_file($conf_file,"PG_USER_MAC");
$dbpass= read_conf_file($conf_file,"PG_PASSWORD_MAC");

$file_index_graphs = read_conf_file($conf_file,"FILE_INDEX_GRAPHS");


print header();

$nom_ap = (param('nom_ap'));

print "<HTML><HEAD><TITLE>infos sur $nom_ap</TITLE>
       <META HTTP-EQUIV=\"Refresh\" CONTENT=\"300\">
       <META HTTP-EQUIV=\"Cache-Control\" content=\"no-cache\">
       <META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">
       </HEAD><BODY>
       <h2 align=center>Quelques infos sur $nom_ap</h2>";

#lecture du fichier des modeles pour recuperation des commentaires
$trafic_ap = "";
$assoc_ap = "";

$nom_trafic = "$nom_ap" . "_trafic";
$nom_assoc = "$nom_ap" . "_associations";

open(MODELE, $file_index_graphs);
while(<MODELE>)
{
        ($nom,$commentaire) = (split(/;/,$_))[0,4];
        #push @tab_modeles_graph, $nom_graph;
	if($nom eq $nom_trafic)
	{
		$trafic_ap = $_;
	}
	elsif($nom eq $nom_assoc)
	{
		$assoc_ap = $_;
	}
}
close(MODELE);

$db =  DBI->connect("dbi:Pg:dbname=$dbname;host=$dbhost", $dbuser, $dbpass )
        or print "$DBI::errstr";

$elem_db = $nom_ap;

$sql = "SELECT assocwifi.mac, assocwifi.essid FROM eq,assocwifi, sessionassocwifi
        WHERE
        assocwifi.idassocwifi =  sessionassocwifi.idassocwifi
        AND eq.ideq = assocwifi.ideq
        AND sessionassocwifi.close = 0
        AND eq.nom = '$elem_db.u-strasbg.fr'
	";
$cursor = $db->prepare($sql);
$cursor->execute;

$t_assoc = 0;
while(($tab[$t_assoc][0],$tab[$t_assoc][1]) = $cursor->fetchrow )
{
	$tab[$t_assoc][2] = "";
	$t_assoc++;
}

if($t_assoc > 0)
{
	$sql = "SELECT  LOWER(authaccess.login), assocwifi.mac, assocwifi.essid
        	FROM authaccess, eq, sessionauthaccess, assocwifi, sessionassocwifi
        	WHERE
       	 	sessionauthaccess.idauthaccess = authaccess.idauthaccess
        	AND assocwifi.idassocwifi =  sessionassocwifi.idassocwifi
        	AND eq.ideq = assocwifi.ideq
        	AND authaccess.mac = assocwifi.mac
        	AND sessionassocwifi.close = 0
        	AND sessionauthaccess.close = 0
        	AND eq.nom = '$elem_db.u-strasbg.fr'";
	$cursor = $db->prepare($sql);
	$cursor->execute;

	while(($login,$mac,$essid) = $cursor->fetchrow)
	{
		for($i=0;$i<$t_assoc;$i++)
		{
			if($mac eq $tab[$i][0] && $essid eq $tab[$i][1])
			{
				$tab[$i][2] = $login;
				$i = $t_assoc;
			}
		}
	}
}

#recuperation de la date actuelle
$date_fin = time;
$date_fin = int($date_fin/300)*300;

$date_dep_daily = $date_fin - 86400;

($batiment) = (split(/-ap/,$nom_ap))[0];

print "<table align=center border=0>
		<tr>
	<td align=center valign=center>
		<a href=https://$server_hostname/wifi/plans/$batiment/$nom_ap.html>
		Où est-il?</a><br>
		<a href=https://$server_hostname/bin/cherche-wifiap?nom_ap=$nom_ap>
		Quel est sa fréquentation?</a><br><br>
		<a href=https://$server_hostname/bin/site-wifi-stats?nom_site=$batiment>
		Retour au bâtiment</a><br>
		
	</td>
	<td align=center valign=center>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	</td>
	<td align=center valign=center>";
if($t_assoc == 0)
{
	print "<b>Pas d'associé sur ce point d'accès</b><br/>";
}
else
{
	print "<b>tableau des associations</b>";
	print " <table align=center border=1>
		<tr>
			<td><b>\@mac</b></td>
			<td><b>ssid</b></td>
			<td><b>login</b></td>
		</tr>";
	
	for($i=0;$i<$t_assoc;$i++)
	{
		print "
                <tr>
                        <td><a href=https://$server_hostname/bin/cherche-wifimac?mac=$tab[$i][0]>
			$tab[$i][0]</a></td>
                        <td>$tab[$i][1]</td>";
		if($tab[$i][2] ne "")
		{	
                	print"<td><a href=https://$server_hostname/bin/cherche-wifiuser?nom_user=$tab[$i][2]>
			<i>$tab[$i][2]</i></a></td>";
		}
		else
		{
			print"<td><i>$tab[$i][2]</i></td>";
		}
                print "</tr>";
	}
	print "</table>";
}
print "</td></tr>
	</table>";
		
$nom_gr = "$nom_assoc!!-!!daily";
print " <table align=center border=0>";
print "<tr>
		<td>";
print "<br><a href=https://$server_hostname/bin/stats?nom_graph=$nom_assoc>
	<IMG BORDER=0 src=\"https://$server_hostname/bin/gengraph?id=$nom_assoc&debut=$date_dep_daily&fin=$date_fin&titre=associations sur $nom_ap&taille=550x150\"></a>
        	</td>
       	</tr>
	<tr>
		<td>";
$nom_gr = "$nom_trafic!!-!!daily";
print "<br><a href=https://$server_hostname/bin/stats?nom_graph=$nom_trafic>
        <IMG BORDER=0 src=\"https://$server_hostname/bin/gengraph?id=$nom_trafic&debut=$date_dep_daily&fin=$date_fin&titre=trafic sur $nom_ap&taille=550x150\" alt=\"Trafic bits/s\"></a>
                </td>
        </tr>
	</table>";	

print "</boby></html>";	

