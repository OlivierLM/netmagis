#!/usr/bin/perl

# $Id: stats,v 1.2 2008/06/13 10:01:06 pda Exp $
#
#
# ###################################################################
# boggia : Creation : 27/03/08
# 
# page de génération des pages de graphiques rrdtools 
#
#

use CGI qw/:standard/;
use CGI::Pretty qw( :html3 );

# fichier de configuration principal et chargement des focntions de base
our $conf_file = "%CONF%";
require "%LIBMETRO%";
#
$server_hostname = read_conf_file($conf_file,"WWW_IDRIS_HOSTNAME");
$www_root = read_conf_file($conf_file,"WWW_IDRIS_DIR_ROOT");
$www_bin = read_conf_file($conf_file,"WWW_IDRIS_DIR_BIN");
$www_img = read_conf_file($conf_file,"WWW_IDRIS_DIR_IMG");
$www_graph = read_conf_file($conf_file,"WWW_IDRIS_DIR_GRAPHS");
# repertoire des binaires
$rep_bin = read_conf_file($conf_file,"DIR_BIN");
#repertoire dans lequel sont stockes les scripts de generation de graphs
$rep_modeles = read_conf_file($conf_file,"DIR_BIN_MODELS");
#repertoire dans lequel se trouve la liste des graphiques existants avec le modele a utiliser
$rep_etc = read_conf_file($conf_file,"DIR_ETC");
#repertoire des bases de données
$rep_db = read_conf_file($conf_file,"DIR_RRD_DB");
#repertoire du fichier de supervision des AP
$rep_var = read_conf_file($conf_file,"DIR_VAR");
#fichier de liste des sites WiFi avec l'ensemble des AP
$liste_sites_wifi = read_conf_file($conf_file,"FILE_LISTE_SITES_WIFI");


#lecture de index.graph contenant la liste des graphiques
@tab_modeles_graph = ();

$taille_tmg = @tab_modeles_graph;

print header();

$nom_graph = (param('nom_graph'));
$param_graph = (param('params_graph'));
$param_g = $param_graph;
$param_g =~s/,/&/g;

if($nom_graph ne "")
{
    #lecture du fichier des modeles pour recuperation des commentaires
    $index = 0;
    open(MODELE, "$rep_etc/index.graph");
    while(<MODELE>)
    {
        ($nom,$commentaire) = (split(/;/,$_))[0,4];
        #push @tab_modeles_graph, $nom_graph;
	if($nom eq $nom_graph)
	{
		$titre = $commentaire;
	}
    }
    close(MODELE);
}

#recuperation de la date actuelle
$date_fin = time;
$date_fin = int($date_fin/300)*300;
$date_dep_daily = $date_fin - 86400;
$date_dep_weekly = $date_fin -  604800;
$date_dep_monthly = $date_fin - 2678400;
$date_dep_yearly = $date_fin - 34560000;

# ecriture de la page cgi
print "<HTML><HEAD><TITLE>$titre</TITLE>
       <META HTTP-EQUIV=\"Refresh\" CONTENT=\"300\">
       <META HTTP-EQUIV=\"Cache-Control\" content=\"no-cache\">
       <META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">
       </HEAD><BODY>
	<h2>$titre</h2>";

if($nom_graph ne "")
{
    print "<a href=https://$server_hostname$www_bin/browse-graph?nom_graph=$nom_graph>BROWSER</a><br>";
}
else
{
    print "<a href=https://$server_hostname$www_bin/browse-graph?params_graph=$param_graph>BROWSER</a><br>";
}

$nom_g = "$nom_graph!!-!!daily";
print "<table>
       <tr>
	    <td>";
	if($nom_graph ne "")
	{
	    print "<IMG src=\"https://$server_hostname$www_bin/gengraph?id=$nom_graph&debut=$date_dep_daily&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">";
	}
	else
	{
	    print "<IMG src=\"https://$server_hostname$www_bin/gengraph?$param_g&debut=$date_dep_daily&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">";
	}
        print "</td></tr>";


$nom_g = "$nom_graph!!-!!weekly";
print "<table>
       <tr>
            <td>";
        if($nom_graph ne "")
        {
            print "<IMG src=\"https://$server_hostname$www_bin/gengraph?id=$nom_graph&debut=$date_dep_weekly&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">";
        }
        else
        {
            print "<IMG src=\"https://$server_hostname$www_bin/gengraph?$param_g&debut=$date_dep_weekly&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">";
        }
        print "</td></tr>";


$nom_g = "$nom_graph!!-!!monthly";


print "<table>
       <tr>
            <td>";
        if($nom_graph ne "")
        {
            print "<IMG src=\"https://$server_hostname$www_bin/gengraph?id=$nom_graph&debut=$date_dep_monthly&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">";
        }
        else
        {
            print "<IMG src=\"https://$server_hostname$www_bin/gengraph?$param_g&debut=$date_dep_monthly&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">";
        }
        print "</td></tr>";


$nom_g = "$nom_graph!!-!!yearly";


print "<table>
       <tr>
            <td>";
        if($nom_graph ne "")
        {
            print "<IMG src=\"https://$server_hostname$www_bin/gengraph?id=$nom_graph&debut=$date_dep_yearly&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">";
        }
        else
        {
            print "<IMG src=\"https://$server_hostname$www_bin/gengraph?$param_g&debut=$date_dep_yearly&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">";
        }
        print "</td></tr>";

print "</table></boby></html>";

