#!/usr/bin/perl

# $Id: browse-graph,v 1.1.1.1 2008-06-13 08:55:51 pda Exp $
#
#
# ###################################################################
# boggia : Creation : 27/03/08
#
# page de génération des pages d'un graphique rrdtool avec le choix
# de l'intervalle de temps
#
#

use CGI qw/:standard/;
use CGI::Pretty qw( :html3 );

# fichier de configuration principal et chargement des focntions de base
our $conf_file = "/local/obj999/etc/obj999.conf";
require "/local/obj999/bin/fonctions-bases-rrd";
#
$server_hostname = read_conf_file($conf_file,"WWW_IDRIS_HOSTNAME");
$www_root = read_conf_file($conf_file,"WWW_IDRIS_DIR_ROOT");
$www_bin = read_conf_file($conf_file,"WWW_IDRIS_DIR_BIN");
$www_img = read_conf_file($conf_file,"WWW_IDRIS_DIR_IMG");
# repertoire des binaires
$rep_bin = read_conf_file($conf_file,"DIR_BIN");
#repertoire dans lequel sont stockes les scripts de generation de graphs
$rep_modeles = read_conf_file($conf_file,"DIR_BIN_MODELS");
#repertoire dans lequel se trouve la liste des graphiques existants avec le modele a utiliser
$rep_etc = read_conf_file($conf_file,"DIR_ETC");
#repertoire des bases de données
$rep_db = read_conf_file($conf_file,"DIR_RRD_DB");
#fichier contenant la liste des graphiques
$index_graph = read_conf_file($conf_file,"FILE_INDEX_GRAPHS");


@descr_erreurs = (' ','ok','disconnected','overThreshold','timeout','busy','notConnected','dropped','sequenceError','verifyError','applicationSpecific','dnsServerTimeout','tcpConnectTimeout','httpTransactionTimeout','dnsQueryError','httpError','error','shadow_injoignable');
@liste_annees = qw(2004 2005 2006 2007 2008);
@liste_mois = qw(01 02 03 04 05 06 07 08 09 10 11 12);
@liste_jours = qw(01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31);
@heures = qw(00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23);

#lecture de index.graph contenant la liste des graphiques
@tab_modeles_graph = ();

$index = 0;
open(MODELE, "$index_graph");
while(<MODELE>)
{
        ($nom_graph,$type,$base_rrd) = (split(/;/,$_))[0,1,3];
	$tab_modeles_graph[$index][0] = $nom_graph;
	$tab_modeles_graph[$index][1] = $type;
	$tab_modeles_graph[$index][2] = $base_rrd;
	$index ++;
}
close(MODELE);

$taille_tmg = @tab_modeles_graph;

print header();

if (param(-name=>'go!'))
{
	$nom_graph = (param('nom_graph'));
	$liste_graph = (param('liste_graph'));
	$heure_dep = (param('heure_dep'));
        $jour_dep = (param('jour_dep'));
        $mois_dep = (param('mois_dep'));
	$annee_dep = (param('annee_dep'));
	$heure_fin = (param('heure_fin'));
        $jour_fin = (param('jour_fin'));
        $mois_fin = (param('mois_fin'));
        $annee_fin = (param('annee_fin'));

	$chaine_date = "date -v$jour_dep" . "d -v$mois_dep" . "m -v$annee_dep" . "y -v$heure_dep" . "H -v00M -v00S";
	$date_dep = `$chaine_date +%s`;
	chomp($date_dep);

	$chaine_date = "date -v$jour_fin" . "d -v$mois_fin" . "m -v$annee_fin" . "y -v$heure_fin" . "H -v00M -v00S";
        $date_fin = `$chaine_date +%s`;
	chomp($date_dep);

        $message_erreur = "";

        if($date_fin < $date_dep)
        {
                $message_erreur = "<br><h3>Attention ! Vous entrez dans la <i>4eme dimension</i> ...</h3>";
        }
        elsif($nom_graph eq "" && $liste_graph ne "--aucun--")
        {
                $nom_graph = $liste_graph;
        }
        elsif($nom_graph eq "" && $liste_graph eq "--aucun--")
        {
                $message_erreur = "<br><h3>Donner un nom de graphique</h3>";
        }


	print "<HTML><HEAD><TITLE>browser</TITLE>
	<META HTTP-EQUIV=\"Cache-Control\" content=\"no-cache\">
	<META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">
	</HEAD>
        <BODY>
        <form>
	Inscrire le nom : <INPUT TYPE=\"TEXT\" NAME=\"nom_graph\" SIZE=\"20\" VALUE=$nom_graph> ou bien :
	<select name=liste_graph><option selected>$liste_graph";
		for($z=0;$z<$taille_tmg;$z++)
		{
			print "<option>$tab_modeles_graph[$z][0]";
		}
	print "</select>
	<br>
        de :<br>
        <select name=heure_dep>";
                foreach $e (@heures)
                {
			if($heure_dep eq $e)
			{
                        	print "<option selected>$e";
			}
			else
			{
				print "<option>$e";
			}
                }
        print "</select>heures, le&nbsp;
        <select name=jour_dep>";
                foreach $e (@liste_jours)
                {
			if($jour_dep eq $e)
                        {
                        	print "<option selected>$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <select name=mois_dep>";
                foreach $e (@liste_mois)
                {
			if($mois_dep eq $e)
                        {
                                print "<option selected>$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }	
                }
        print "</select>
        <select name=annee_dep>";
                foreach $e (@liste_annees)
                {
                        if($annee_dep eq $e)
                        {
                                print "<option selected>$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <br>
        à :<br>
        <select name=heure_fin>";
                foreach $e (@heures)
                {
                        if($heure_fin eq $e)
                        {
                                print "<option selected>$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>heures, le&nbsp;
        <select name=jour_fin>";
                foreach $e (@liste_jours)
                {
                       	if($jour_fin eq $e)
                        {
                                print "<option selected>$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <select name=mois_fin>";
                foreach $e (@liste_mois)
                {
                        if($mois_fin eq $e)
                        {
                                print "<option selected>$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
        print "</select>
        <select name=annee_fin>";
                foreach $e (@liste_annees)
                {
                        if($annee_fin eq $e)
                        {
                                print "<option selected>$e";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }

	print "</select>
        <br><br>
        <input type=submit name=\"go!\" value=\"go!\">
        </form>";

	if($message_erreur ne "")
	{
		print $message_erreur;
	}
	else
	{
		for($z=0;$z<$taille_tmg;$z++)
                {
			if($nom_graph eq $tab_modeles_graph[$z][0] && $tab_modeles_graph[$z][1] eq "SaaHttp")
			{
				$graph_saaHttp = 1;
				$base_temp = $tab_modeles_graph[$z][2];
			}
                }

		print "<br>
		<img src=\"https://$server_hostname$www_bin/gengraph?id=$nom_graph&debut=$date_dep&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">
		<br>";
	}
	print "<br></BODY></HTML> ";
}
else
{
	$nom_graph = (param('nom_graph'));
	$liste_graph = "--aucun--";

	$date = `date +%F-%H`;

	($a,$m,$j,$h) = (split(/-/,$date))[0,1,2,3];

	$chaine_date = "date -v$j" . "d -v$m" . "m -v$a" . "y -v00H -v00M -v00S";
	$date_dep = `$chaine_date +%s`;
	chomp($date_dep);
	$chaine_date = "date -v$j" . "d -v$m" . "m -v$a" . "y -v$heure_fin" . "H -v00M -v00S";
        $date_fin = `$chaine_date +%s`;
	chomp($date_fin);

	print "<HTML><HEAD><TITLE>browser</TITLE>
	<META HTTP-EQUIV=\"Cache-Control\" content=\"no-cache\">
	<META HTTP-EQUIV=\"Pragma\" CONTENT=\"no-cache\">
	</HEAD>
	<BODY>
	<form>
	Inscrire le nom : <INPUT TYPE=\"TEXT\" NAME=\"nom_graph\" SIZE=\"20\" VALUE=$nom_graph> ou bien :
	<select name=liste_graph><option selected>$liste_graph";
	 for($z=0;$z<$taille_tmg;$z++)
         {
         	print "<option>$tab_modeles_graph[$z][0]";
         }
	
	print "</select>
	<br>
	de :<br> 
	<select name=heure_dep>";
        	foreach $e (@heures)
                {
                        print "<option>$e";
                }
	print "</select>heures, le&nbsp;
	<select name=jour_dep>";
                foreach $e (@liste_jours)
                {
			if($j == $e)
                        {
                                print "<option selected>$j";
                        }
                        else
                        {
                                print "<option>$e";
                        }
                }
	print "</select>
	<select name=mois_dep>";
                foreach $e (@liste_mois)
                {
                        if($m == $e)
			{
				print "<option selected>$m";
			}
			else
			{
				print "<option>$e";
			}
                }
	print "</select>
	<select name=annee_dep>";
                foreach $e (@liste_annees)
                {
			if($a == $e)
			{
				print "<option selected>$a";
			}
			else
			{
                        	print "<option>$e";
			}
                }
	print "</select>
	<br>
	à :<br>
	<select name=heure_fin>";
                foreach $e (@heures)
                {
			if($h == $e)
			{
				print "<option selected>$h";
			}
			else
			{
				print "<option>$e";
			}
                }
	print "</select>heures, le&nbsp;
	<select name=jour_fin>";
                foreach $e (@liste_jours)
                {
			if($j == $e)
			{
				print "<option selected>$j";
			}
			else
			{
                        	print "<option>$e";
			}
                }
	print "</select>
	<select name=mois_fin>";
                foreach $e (@liste_mois)
                {
			if($m == $e)
			{
				print "<option selected>$m";
			}
			else
			{
                        	print "<option>$e";
			}
                }
	print "</select>
	<select name=annee_fin>";
                foreach $e (@liste_annees)
                {
			if($a == $e)
			{
                        	print "<option selected>$a";
			}
			else
			{
				print "<option>$e";
			}
                }
	print "</select>
	<br><br>
	<input type=submit name=\"go!\" value=\"go!\">
	</form>";
	print "<img src=\"https://$server_hostname$www_bin/gengraph?id=$nom_graph&debut=$date_dep&fin=$date_fin&taille=650x180\" alt=\"Trafic bits/s\">
	<br>
	</BODY></HTML> ";
}

sub calcule_dispo {
                ($date_dep,$date_fin,$base)=@_;
                %erreurs = ('total' => '0','ok' => '0','disconnected' => '0','overThreshold' => '0','timeout' => '0','busy' => '0','notConnected' => '0','dropped' => '0','sequenceError' => '0','verifyError' => '0','applicationSpecific' => '0','dnsServerTimeout' => '0','tcpConnectTimeout' => '0','httpTransactionTimeout' => '0','dnsQueryError' => '0','httpError' => '0','error' => '0','shadow_injoignable' => '0');

		$temp = `rrdtool fetch $base MAX -r 300 --start $date_dep --end $date_fin | awk '{print \$7}'`;
                @dump = split(/\n/,$temp);
                $total = 0;
                $ok = 0;
                foreach $elem (@dump)
                {
                        if($elem == 1 || $elem == 17 || $elem eq "nan" || $elem eq "")
                        {
                                $ok ++;
                                if($elem ne "nan" && $elem ne "")
                                {
                                        $erreurs{$descr_erreurs[$elem]} ++;
                                }
                        }
                        else
                        {
                                $erreurs{$descr_erreurs[$elem]} ++;
                        }
                        $total ++;
                        $erreurs{'total'} ++;
                }
                $disponibilite = (100 / $total) * $ok;
                return ($disponibilite,%erreurs);
}

