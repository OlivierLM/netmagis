#!/usr/bin/perl

# $Id: wifi-ferme-session-user,v 1.1.1.1 2008-06-13 08:55:51 pda Exp $
#
# ###################################################################
# boggia : Creation : 04/04/08
#
# ferme les sessions WiFi pour les utilisateurs apres un timeout
#

use DBI;

$log = $ARGV[0];
# fichier de configuration principal et chargement des focntions de base
our $conf_file = "/local/obj999/etc/obj999.conf";
require "/local/obj999/bin/fonctions-bases-rrd";
#

our $file_maj_sondes = read_conf_file("$conf_file","FILE_METRO_UPDATE_PROBES");
our $file_majMETRO = read_conf_file("$conf_file","FILE_METRO_PROBES");
our $rep_db = read_conf_file("$conf_file","DIR_RRD_DB_METRO");
our $rep_lock = read_conf_file("$conf_file","DIR_LOCK_UPDATE_METRO");
our $rep_bin = read_conf_file("$conf_file","DIR_BIN");
our $rep_sondes = read_conf_file("$conf_file","DIR_BIN_PROBES");
our $rep_majdb = read_conf_file("$conf_file","DIR_PROBES");
our $file_quarantaine = read_conf_file("$conf_file","FILE_METRO_QUARANTINE");
our $dbhost = read_conf_file($conf_file,"MAC_PSQL_SERVER");
our $dbname= read_conf_file($conf_file,"PG_DATABASE_MAC");
our $dbuser= read_conf_file($conf_file,"PG_USER_MAC");
our $dbpass= read_conf_file($conf_file,"PG_PASSWORD_MAC");

$defaultdomain="u-strasbg.fr";

$db =  DBI->connect("dbi:Pg:dbname=$dbname;host=$dbhost", $dbuser, $dbpass )
        or print STDERR "$DBI::errstr";

#
#$r = $db->prepare("UPDATE sessionauthaccess SET close=1 WHERE close = 0 and (now() - interval '8 minutes') >= fin;");

# ne ferme que les session oubliees du portail captif
$r = $db->prepare("UPDATE sessionauthaccess
		    SET close=1
		    FROM authaccess
		    WHERE sessionauthaccess.close = 0
		    and (now() - interval '6 minutes') >= sessionauthaccess.fin
		    and authaccess.idauthaccess = sessionauthaccess.idauthaccess
		    and authaccess.ideq = 469;");

##########################################################################
$r->execute or print STDERR "Update : $DBI::errstr";
##########################################################################

$r->finish;
