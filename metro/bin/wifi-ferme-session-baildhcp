#!/usr/bin/perl

# $Id: wifi-ferme-session-baildhcp,v 1.2 2008-06-13 10:16:50 pda Exp $
#
# ###################################################################
# boggia : Creation : 04/04/08
#
# ferme les sessions des baux DHCP oubliés
#


use DBI;

$log = $ARGV[0];
# fichier de configuration principal et chargement des focntions de base
our $conf_file = "%CONF%";
require "%LIBMETRO%";
#

our $file_maj_sondes = read_conf_file("$conf_file","FILE_METRO_UPDATE_PROBES");
our $file_majMETRO = read_conf_file("$conf_file","FILE_METRO_PROBES");
our $rep_db = read_conf_file("$conf_file","DIR_RRD_DB_METRO");
our $rep_lock = read_conf_file("$conf_file","DIR_LOCK_UPDATE_METRO");
our $rep_bin = read_conf_file("$conf_file","DIR_BIN");
our $rep_sondes = read_conf_file("$conf_file","DIR_BIN_PROBES");
our $rep_majdb = read_conf_file("$conf_file","DIR_PROBES");
our $file_quarantaine = read_conf_file("$conf_file","FILE_METRO_QUARANTINE");
our $dbhost = read_conf_file($conf_file,"MAC_PSQL_SERVER");
our $dbname= read_conf_file($conf_file,"PG_DATABASE_MAC");
our $dbuser= read_conf_file($conf_file,"PG_USER_MAC");
our $dbpass= read_conf_file($conf_file,"PG_PASSWORD_MAC");


$defaultdomain="u-strasbg.fr";

$db =  DBI->connect("dbi:Pg:dbname=$dbname;host=$dbhost", $dbuser, $dbpass )
        or print STDERR "$DBI::errstr";

$r = $db->prepare("UPDATE sessionbaildhcp SET close=1 WHERE close = 0 and (now() - interval '5 minutes') >= fin;");
##############################################################
$r->execute or print STDERR "Update : $DBI::errstr";
##############################################################
$r->finish;
