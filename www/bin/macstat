#!%TCLSH%

#
# Script qui affiche des statistiques
# sur les informations contenues dans la base MAC
#
# History
#   2005/05/27 : jean : conception
#   2010/11/30 : pda/jean : integration a WebDNS
#


#
#


#
# Template pages used by this script
#

set conf(err)           erreur.html
set conf(page)          macstat.html

#
# Script parameters
#

set conf(dbmac)          %BASEMAC%


lappend auto_path %PKGTCL%
package require webdns

#
# Formats du tableau
#

set conf(tabresultat) {
    global {
        chars {12 normal}
        align {left}
        botbar {yes}
        columns {75 25}
    }   
    pattern Normal {
        vbar {yes}
        column { }
        vbar {yes}
        column { }
        vbar {yes}
    }
}

#
#

# ::webapp::cgidebug ; exit


#
# Calcule les statistiques sur les adresses
#

proc stat-adr {dbfd} {
    global conf

    # liste de couples description - requetes
    set req {
    "Nombre d'adresses mac uniques"
    "SELECT count(DISTINCT mac) AS r FROM portmac" 
    "Nombre d'adresses IPv4 uniques"
    "SELECT count(DISTINCT ip) AS r FROM ipmac WHERE family(ip)=4"
    "Nombre d'adresses IPv6 uniques"
    "SELECT count(DISTINCT ip) AS r FROM ipmac WHERE family(ip)=6"
    "Nombre d'adresses MAC distinctes associées à une adresse IPv6"
    "SELECT count(DISTINCT(mac)) AS r FROM ipmac WHERE family(ip)=6"
    }

    set data {}

    foreach {description requete} $req {
	set resultat ""
	pg_select $dbfd $requete tab {
	    set resultat $tab(r)
	}
	lappend data [list Normal $description $resultat]
    }
    append tableau [::arrgen::output "html" $conf(tabresultat) $data]

    return $tableau
}

#
# Main procedure
#

proc main {} {
    global conf

    #
    # Initialization
    #

    ::dnscontext create d
    d init-cgi "mac" $conf(err) "" {} ftab dbfd login tabuid

    #
    # Accès à la base MAC
    #

    if {[catch {set dbfdmac [pg_connect -conninfo $conf(dbmac)]} msg]} then {
        ::webapp::error-exit $conf(err) $msg
    }

    #
    # Génère le tableau html de résultat
    #

    set tableau [stat-adr $dbfdmac]

    #
    # End of script: output page and close database
    #

    d result $conf(page) [list \
                                [list %TITRE%   "Statistiques sur les adresses MAC/IP"] \
                                [list %TABLEAU% $tableau] \
                            ]
}

::webapp::cgi-exec main
