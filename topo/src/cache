#!%TCLSH%

#  
# Topo program result cache  
#
# History
#  2011/01/13 : jean : design
#

source %LIBNETMAGIS%

#
# Main program
#

proc main {argv0 argv} {
    global conf
    global ctxt

    #
    # Argument test
    #
    
    set cmd [join $argv " "]
    if {$cmd eq ""} then {
    	puts stderr "Usage : $argv0 cmd args ..."
	return -1
    }

    set ctxt(dbfd1) ""
    set ctxt(dbfd2) ""
    set-log [get-local-conf "logger"]

    set conf(cachedir) [get-local-conf "cachedir"]

    #
    # Connect to database
    #

    config ::dnsconfig
    lazy-connect

    #
    # Calculate a hash and check if it is already in cache
    #

    set hash [md5::md5 -hex $cmd]

    set r 0
    set output ""
    if {[in-cache $hash]} then {
	hit-cache $hash
    } else {

    	#
    	# Not in cache, execute and update cache
    	#

	set t1 [clock seconds]
	set run $cmd
	regsub -all {[<>|;'"${}()&\[\]*?]} $run {\\&} run
	if {[catch {exec sh -c $run} output]} then {
	    puts stderr "command '$run' execution error ('$output')"
	    set r 1
	} else {
	    set t2 [clock seconds]
    	    puts $output
	    update-cache $cmd $hash $output [expr $t2 - $t1]
	}
    }
    
    return $r
}

exit [main $argv0 $argv]
